test_that("armadillo.upload_table checks if table is provided", {
  expect_error(
    armadillo.upload_table(project="project", folder = "folder"),
    "argument \"table\" is missing, with no default"
  )
})

test_that("armadillo.upload_table checks if folder is provided", {
  expect_error(
    armadillo.upload_table(project="project", table = datasets::iris),
    "argument \"folder\" is missing, with no default"
  )
})

test_that("armadillo.upload_table checks if the project exists", {
  bucket_exists <- mock(FALSE)
  
  expect_error(
    with_mock(
      armadillo.upload_table(
        project = "project",
        folder = "example",
        table = datasets::iris
      ),
      "aws.s3::bucket_exists" = bucket_exists,
      "MolgenisArmadillo:::.use_https" = mock(TRUE)
    ),
    "Project 'project' does not exist\\."
  )

  expect_args(bucket_exists, 1, "shared-project", use_https = TRUE)
})

test_that("armadillo.upload_table uploads table", {
  put_object <- mock(TRUE)
  bucket_exists <- mock(TRUE)
  file <- tempfile()
  # Cannot mock base functions, so stub it instead
  stub(armadillo.upload_table, "tempfile", file)

  expect_message(
    with_mock(
      result <- armadillo.upload_table(
        project = "project",
        folder = "folder",
        table = datasets::iris
      ),
      "aws.s3::put_object" = put_object,
      "aws.s3::bucket_exists" = bucket_exists,
      "MolgenisArmadillo:::.use_https" = mock(FALSE, cycle = TRUE)
    ),
    "Compressing table...|Uploaded table folder/datasets::iris",
    all=TRUE
  )

  expect_true(result)
  
  expect_args(put_object, 1,
              file = file,
              object = "folder/datasets::iris.parquet",
              bucket = "shared-project",
              multipart = TRUE,
              show_progress = interactive(),
              use_https = FALSE
  )
})

test_that("armadillo.list_tables checks if the project exists", {
  bucket_exists <- mock(FALSE)

  expect_error(
    with_mock(
      armadillo.list_tables("project"),
      "aws.s3::bucket_exists" = bucket_exists,
      "MolgenisArmadillo:::.use_https" = mock(TRUE)
    ),
    "Project 'project' does not exist\\."
  )

  expect_args(bucket_exists, 1, "shared-project", use_https = TRUE)
})

test_that("armadillo.list_tables lists the tables in a project", {
  bucket_exists <- mock(TRUE)
  get_bucket <- mock(tables)

  with_mock(
    result <- armadillo.list_tables("project"),
    "aws.s3::get_bucket" = get_bucket,
    "aws.s3::bucket_exists" = bucket_exists,
    "MolgenisArmadillo:::.use_https" = mock(FALSE, cycle = TRUE)
  )

  expect_equal(result, c("patient", "test"))
  expect_args(get_bucket, 1,
    bucket = "shared-project",
    use_https = FALSE
  )
})

test_that("armadillo.delete_table checks if the project exists", {
  bucket_exists <- mock(FALSE)

  expect_error(
    with_mock(
      armadillo.delete_table("project", "test"),
      "aws.s3::bucket_exists" = bucket_exists,
      "MolgenisArmadillo:::.use_https" = mock(TRUE)
    ),
    "Project 'project' does not exist\\."
  )

  expect_args(bucket_exists, 1, "shared-project", use_https = TRUE)
})

test_that("armadillo.delete_table checks if the table exists", {
  head_object <- mock(FALSE)

  expect_error(
    with_mock(
      armadillo.delete_table("project", "folder", "test"),
      "aws.s3::bucket_exists" = mock(TRUE),
      "aws.s3::head_object" = head_object,
      "MolgenisArmadillo:::.use_https" = mock(TRUE, cycle = TRUE)
    ),
    "Table 'folder/test' does not exist\\."
  )

  expect_args(head_object, 1, "folder/test.parquet", "shared-project", use_https = TRUE)
})

test_that("armadillo.delete_workspace deletes a workspace", {
  delete_object <- mock(TRUE)

  expect_message(
    result <- with_mock(
      armadillo.delete_workspace("example", "test"),
      "aws.s3::bucket_exists" = mock(TRUE),
      "aws.s3::head_object" = mock(TRUE),
      "MolgenisArmadillo:::.use_https" = mock(TRUE, cycle = TRUE),
      "aws.s3::delete_object" = delete_object
    ),
    "Deleted workspace 'test'\\."
  )

  expect_true(result)
})

test_that("armadillo.delete_workspace checks if the source folder exists", {
  bucket_exists <- mock(FALSE)

  expect_error(
    with_mock(
      armadillo.copy_workspace(
        folder = "example",
        name = "tim_subset_1",
        new_folder = "gecko_subset_1"
      ),
      "aws.s3::bucket_exists" = bucket_exists,
      "MolgenisArmadillo:::.use_https" = mock(TRUE)
    ),
    "Folder 'example' does not exist\\."
  )

  expect_args(bucket_exists, 1, "shared-example", use_https = TRUE)
})

test_that("armadillo.copy_workspace checks if the source workspace exists", {
  head_object <- mock(FALSE)

  expect_error(
    with_mock(
      armadillo.copy_workspace(
        folder = "example",
        name = "test",
        new_folder = "gecko_subset_1"
      ),
      "aws.s3::bucket_exists" = mock(TRUE),
      "aws.s3::head_object" = head_object,
      "MolgenisArmadillo:::.use_https" = mock(TRUE, cycle = TRUE)
    ),
    "Workspace 'test' does not exist\\."
  )

  expect_args(head_object, 1, "test.RData", "shared-example", use_https = TRUE)
})

test_that("armadillo.copy_workspace checks if the target folder exists", {
  bucket_exists <- mock(TRUE, FALSE)

  expect_error(
    with_mock(
      armadillo.copy_workspace(
        folder = "example",
        name = "test",
        new_folder = "target"
      ),
      "aws.s3::bucket_exists" = bucket_exists,
      "aws.s3::head_object" = mock(TRUE),
      "MolgenisArmadillo:::.use_https" = mock(TRUE, cycle = TRUE)
    ),
    "Folder 'target' does not exist\\."
  )

  expect_args(bucket_exists, 2, "shared-target", use_https = TRUE)
})

test_that("armadillo.copy_workspace warns if you copy object onto itself", {
  expect_error(
    armadillo.copy_workspace(
      folder = "example",
      name = "test",
      new_folder = "example"
    ),
    "Cannot copy workspace onto itself\\."
  )
})

test_that("armadillo.copy_workspace copies workspace", {
  copy_object <- mock(TRUE)

  expect_message(
    with_mock(
      result <- armadillo.copy_workspace(
        folder = "example",
        name = "test",
        new_folder = "target"
      ),
      "aws.s3::bucket_exists" = mock(TRUE, cycle = TRUE),
      "aws.s3::head_object" = mock(TRUE),
      "aws.s3::copy_object" = copy_object,
      "MolgenisArmadillo:::.use_https" = mock(TRUE, cycle = TRUE)
    ),
    "Copied workspace 'test' to folder 'target'\\."
  )

  expect_true(result)
  expect_args(copy_object, 1,
    from_object = "test.RData",
    to_object = "test.RData",
    from_bucket = "shared-example",
    to_bucket = "shared-target",
    use_https = TRUE
  )
})

test_that("armadillo.load_workspace checks if the folder exists", {
  bucket_exists <- mock(FALSE)

  expect_error(
    with_mock(
      armadillo.load_workspace(
        folder = "example",
        name = "tim_subset_1"
      ),
      "aws.s3::bucket_exists" = bucket_exists,
      "MolgenisArmadillo:::.use_https" = mock(TRUE)
    ),
    "Folder 'example' does not exist\\."
  )

  expect_args(bucket_exists, 1, "shared-example", use_https = TRUE)
})

test_that("armadillo.load_workspace checks if the workspace exists", {
  head_object <- mock(FALSE)

  expect_error(
    with_mock(
      armadillo.copy_workspace(
        folder = "example",
        name = "test",
        new_folder = "gecko_subset_1"
      ),
      "aws.s3::bucket_exists" = mock(TRUE),
      "aws.s3::head_object" = head_object,
      "MolgenisArmadillo:::.use_https" = mock(TRUE, cycle = TRUE)
    ),
    "Workspace 'test' does not exist\\."
  )

  expect_args(head_object, 1, "test.RData", "shared-example", use_https = TRUE)
})

test_that("armadillo.load_workspace loads the workspace", {
  s3load <- mock(invisible(NULL))
  environment <- new.env()

  expect_silent(
    with_mock(
      result <- armadillo.load_workspace(
        folder = "example",
        name = "test",
        env = environment
      ),
      "aws.s3::bucket_exists" = mock(TRUE),
      "aws.s3::head_object" = mock(TRUE),
      "aws.s3::s3load" = s3load,
      "MolgenisArmadillo:::.use_https" = mock(TRUE, cycle = TRUE)
    )
  )

  expect_equal(result, invisible(NULL))
  expect_args(s3load, 1,
    object = "test.RData",
    bucket = "shared-example",
    use_https = TRUE,
    envir = environment
  )
})

test_that("armadillo.move_workspace calls copy and delete", {
  copy_workspace <- mock(TRUE)
  delete_workspace <- mock(TRUE)
  expect_message(
    with_mock(
      armadillo.move_workspace("example", "test", "example2"),
      "MolgenisArmadillo::armadillo.copy_workspace" = copy_workspace,
      "MolgenisArmadillo::armadillo.delete_workspace" = delete_workspace
    ), "Moved workspace 'test' to folder 'example2'\\."
  )

  expect_args(copy_workspace, 1, "example", "test", "example2")
  expect_args(delete_workspace, 1, "example", "test")
})
